\section{Causal Mediation in Applied Settings}
\label{sec:selection}
In this section, I further develop the issue of selection in causal mediation estimates. First, I show the non-parametric bias terms from above can be written as omitted variables bias in a regression framework.
Second, I show how selection bias operates in an applied model for selection into a mediator based on costs and benefits.

\subsection{Regression Framework}
\label{sec:regression}
Inference for CM effects can be written in a regression framework, showing how correlation between the error term and the mediator persistently biases estimates.
Write $Y_i(Z, D)$ as a sum of observed factors $Z_i, \vec X_i$ and unobserved factors, $U_{1,i}, U_{0,i}$ (following the notation of \citealt{heckman2005structural}).
For $z',d' = 0,1$, put $\mu_{d'}(z'; \vec X_i) = \Egiven{Y_i(z', d')}{\vec X}$, to give a representation of the ADE and AIE.
\begin{align*}
    \text{ADE}
    = \E{Y_i(Z_i, D_i(1)) - Y_i(Z_i, D_i(0))}
    &= \mathbb{E} \Big[ \Big( D_i(1) - D_i(0) \Big)
        \times \Big( \mu_1(Z_i; \vec X_i) - \mu_0(Z_i; \vec X_i) \Big) \Big], \\
    \text{AIE}    
    = \E{Y_i(1, D_i(Z_i)) - Y_i(0, D_i(Z_i))}
        &= \mathbb{E} \Big[ \mu_{D_i}(1; \vec X_i) - \mu_{D_i}(0; \vec X_i) \Big].
\end{align*}
Then define the error terms.
\[ U_{0,i} = Y_i(Z_i, 0) - \mu_0(Z_i; \vec X_i),\;\;\;\;
U_{1,i} = Y_i(Z_i, 1) - \mu_1(Z_i; \vec X_i) \]
With this notation, observed data $Z_i, D_i, Y_i$ take the following representation, which characterises direct effects, indirect effects, and selection bias.
\begin{align}
    \label{eqn:parametric-firststage}
    D_i &= \phi + \pi Z_i + \varphi(\vec X_i) + \eta_i  \\
    \label{eqn:parametric-secondstage}
    Y_i &= \alpha + \beta D_i + \gamma Z_i + \delta Z_i D_i
    + \zeta(\vec X_i)
    + \underbrace{\left(1 - D_i \right)U_{0,i} + D_i U_{1,i}}_{
        \text{Correlated error term.}}
\end{align}
First-stage \eqref{eqn:parametric-firststage} is identified, with $\phi, \varphi(\vec X_i)$ the intercept, and $\pi$ the average rate of compliance (which may depend on $\vec X_i$).
Second-stage \eqref{eqn:parametric-secondstage} is not identified thanks to omitted variables bias.
$\alpha, \zeta(\vec X_i)$ are the intercept terms, and $\beta, \gamma, \delta$ are values that comprise mediation effects --- all whose values may depend on $\vec X_i$, see \autoref{appendix:regression-model} for full definitions.
$\left(1 - D_i \right)U_{0,i} + D_i U_{1,i}$ is the possibly correlated error term, which disrupts identification.
The ADE and AIE are averages of these coefficients.\footnote{
    The AIE, in fact, refers only to treatment gains among $D_i(z)$ compliers, so has the more complicated form $\mathbb E \Big[ 
        \pi \times \Egiven{\beta +  \delta Z_i}{D_i(1) = 1, D_i(0) = 0} \Big]$.
    The formula above skips the local to compliers part, to keep with regression notation.
}
\begin{align*}
    \text{ADE:} \;\; \E{Y_i(1, D_i(Z_i)) - Y_i(0, D_i(Z_i))}
        &= \E{\gamma + \delta D_i}, \\
    \text{AIE:} \;\; \E{Y_i(Z_i, D_i(1)) - Y_i(Z_i, D_i(0))}
        &= \E{ \pi \left( \beta +  \delta Z_i \right)}.
\end{align*}
By construction, $U_i = U_{0, i} - U_{1, i}$ is an unobserved confounder.
The regression estimates of second-stage \eqref{eqn:parametric-secondstage} give unbiased estimates only if $D_i$ is also conditionally ignorable: $D_i \indep  U_i$.
If not, then regression estimates suffer from omitted variables bias if they do not adjust for the unobserved confounder $U_i$.

\subsection{Selection on Costs and Benefits}
CM is at risk of bias because $D_i \indep  U_i$ is unlikely to hold in applied settings.
Without an identification strategy for $D_i$ (in addition to one for $Z_i$), bias will persist, given how we conventionally think of selection into treatment.

Consider a model where individual $i$ selects into a mediator based on costs and benefits, after $Z_i, \vec X_i$ have been assigned.
Write $C_i$ for individual $i$'s costs of taking mediator $D_i$, and $\indicator{.}$ for the indicator function.
The Roy model has $i$ taking the mediator if the benefits exceed the costs.
\[ D_i \left( z' \right) = \indicator{
    \underbrace{Y_i\left( z', 1 \right) - Y_i\left( z', 0 \right)}_{\text{Benefits}}
    \geq \underbrace{C_i}_{\text{Costs}}}, \;\;\; \text{for } z'=0,1 \]
The Roy model provides a robust and intuitive framework for analysing selection mechanisms because it captures the fundamental economic principle of decision-making based on costs and benefits in terms of the outcome observed \citep{roy1951some,heckman1990empirical}.
If the outcome $Y_i$ is a measure of income, and the mediator a choice of taking education, then it models an individual choice to attend more education in terms of gaining a higher income.\footnote{
    If the choice is made for a sum of outcomes, then a simple extension of the framework to a utility maximisation model maintains the same spirit.
    See \cite{heckman1990empirical} for this approach.
}
This makes it particularly useful as a base case when studying causal mediation, where selection into the mediator may be driven by private information (unobserved by the researcher).
Additionally, the Roy model aligns well with many real-world settings, such as education or labour market participation, where decisions are based on a comparison of expected outcomes across alternatives.  
By using the Roy model as a benchmark, I explore the practical limits of the mediator ignorability assumption.

Decompose the costs into its mean and unobserved error, as above $C_i(Z_i) = \mu_{C}(Z_i; \vec X_i) + U_{C,i}$, and collect the mean benefits, $\mu \coloneqq \mu_1 - \mu_0$.
So we can write the first-stage selection equation separated by observed means and unobserved errors.
\begin{align*}
    D_i(z') &= \indicator{
        \mu(z'; \vec X_i) - \mu_C(z'; \vec X_i) \geq U_{C,i} - U_i }
        , \;\;\; \text{for } z'=0,1
\end{align*}

If selection is Roy style, and the mediator is ignorable, then unobserved benefits play no part in selection.
The only driver in differences in selection are differences in costs (and not benefits).
\[ \Egiven{ D_i(z') }{ U_i = u} = \Egiven{ D_i(z') }{ U_i = u'} \]
For all $u', u$ in the range of the distribution of $U_i = U_{1,i} - U_{0,i}$.
This could, for example, hold if $U_{0,i}, U_{1,i}$ are degenerate conditional on $\vec X_i$.\footnote{
    This statement holds by a simple proof by contradiction: suppose there are $u', u$ such that the statement does not hold, then $D_i$ cannot be ignorable.
}

This means than the vector of control variables $\vec X_i$ must be incredibly rich.
Together, $\vec X_i$ and unobserved cost differences $U_{C,i}$ must explain selection into $D_i$ one hundred percent.
In the Roy model framework, however, individuals make decisions about mediator take-up based on gains, which the researcher may not observe fully. 
These unobservables are unlikely to be fully captured by any observable control set $\vec{X}_i$.\footnote{
    In a similar sense, \cite{huber2024testing} give a method to  test the implications of sequential ignorability (requiring an instrument).
}
Consequently, the assumption of mediator ignorability is implausible in most practical settings (absent a separate research design for $D_i$).

% \subsection{Applied Settings}
% 
% Three parapgraphs on what goes on in empirical settings.
% Survey the papers, and speak about it heavily in one paragraph.
% 
% table:
% 
% name | $Z \to Y$ | design for $Z$ | Primary mediatory | controls | Possible $U$.
% 