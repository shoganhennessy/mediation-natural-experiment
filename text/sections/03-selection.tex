\section{Causal Mediation in Applied Settings}
\label{sec:selection}
In this section, I further develop the issue of selection in causal mediation estimates. First, I show the non-parametric bias terms from above can be written as omitted variables bias in a regression framework.
Second, I show how selection bias operates in an applied model for selection into a mediator based on costs and benefits.

\subsection{Regression Framework}
\label{sec:regression}
Inference for direct and direct effects can be written in a regression framework, showing how correlation between the error term and the mediator persistently biases estimates.
Write $Y_i(Z, D)$ as a sum of observed factors $Z_i, \vec X_i$ and unobserved factors, $U_{1,i}, U_{0,i}$ (following the notation of \citealt{heckman2005structural}).
Put $\mu_D(Z; \vec X_i) = \Egiven{Y_i(Z_i, 0)}{\vec X}$, to give a representation of the average direct and indirect effects.
\begin{align*}
    \E{Y_i(Z_i, D_i(1)) - Y_i(Z_i, D_i(0))}
    &= \mathbb{E} \Big[ \Big( D_i(1) - D_i(0) \Big)
        \times \Big( \mu_1(Z_i; \vec X_i) - \mu_0(Z_i; \vec X_i) \Big) \Big], \\
    \E{Y_i(1, D_i(Z_i)) - Y_i(0, D_i(Z_i))}
        &= \mathbb{E} \Big[ \mu_{D_i}(1; \vec X_i) - \mu_{D_i}(0; \vec X_i) \Big].
\end{align*}
Then define the error terms.
\[ U_{0,i} = Y_i(Z_i, 0) - \mu_0(Z_i; \vec X_i),\;\;\;\;
U_{1,i} = Y_i(Z_i, 1) - \mu_1(Z_i; \vec X_i) \]
With this notation, observed data $Z_i, D_i, Y_i$ take the following representation, which characterises direct effects, indirect effects, and bias from selection.
\begin{align}
    \label{eqn:parametric-firststage}
    D_i &= \phi + \pi Z_i + \varphi(\vec X_i) + \eta_i  \\
    \label{eqn:parametric-secondstage}
    Y_i &= \alpha + \beta D_i + \gamma Z_i + \delta Z_i D_i
    + \zeta(\vec X_i)
    + \underbrace{U_{0,i} + D_i \left( U_{1,i} - U_{0,i} \right)}_{
        \text{Correlated error term.}}
\end{align}
First-stage \eqref{eqn:parametric-firststage} is identified, with $\phi, \varphi(\vec X_i)$ the intercept, and $\pi$ the average rate of compliance (which may depend on $\vec X_i$).
Second-stage \eqref{eqn:parametric-secondstage} is not identified without further assumptions.
$\alpha, \zeta(\vec X_i)$ are the intercept terms, and $\beta, \gamma, \delta$ are values that comprise mediation effects --- all whose values may depend on $\vec X_i$, see \autoref{appendix:regression-model} for full definitions.
$U_{0,i} + D_i \left( U_{1,i} - U_{0,i} \right)$ is the possibly correlated error term, which disrupts identification.
The average direct and indirect effects are averages of these coefficients.
\begin{align*}
    \E{Y_i(Z_i, D_i(1)) - Y_i(Z_i, D_i(0))}
        &= \E{\pi \left( \beta +  Z_i \delta \right)}, \\
    \E{Y_i(1, D_i(Z_i)) - Y_i(0, D_i(Z_i))}
        &= \E{\gamma + \delta D_i}.
\end{align*}
By construction, $U_i = U_{1, i} - U_{0, i}$ is an unobserved confounder.
The regression estimates of second-stage \eqref{eqn:parametric-secondstage} give unbiased estimates only if $D_i$ is also conditionally ignorable: $D_i \indep  U_i$.
If not, then regression estimates suffer from omitted variables bias if they do not adjust for the unobserved confounder $U_i$.

\subsection{Selection on Costs and Benefits}
The key to noting that CM is at risk of bias is noting that $D_i \indep  U_i$ is unlikely to hold in applied settings.
Without an identification strategy for $D_i$, in addition one for $Z_i$, bias will persist, given how we conventionally think of selection into treatment.

Consider a model where individual $i$ selects into a mediator based on costs and benefits, after $Z_i, \vec X_i$ have been assigned.
Write $C_i$ for individual $i$'s costs of taking mediator $D_i$, and $\indicator{.}$ for the indicator function.
The Roy model has $i$ taking the mediator if the benefits exceed the costs.
\[ D_i \left( z' \right) = \indicator{
    \underbrace{Y_i\left( z', 1 \right) - Y_i\left( z', 0 \right)}_{\text{Benefits}}
    \geq \underbrace{C_i}_{\text{Costs}}}, \;\;\; \text{for } z'=0,1 \]
Paragraph here talking about why the Roy model is useful.
\citep{roy1951some,heckman1990empirical}.

Decompose the costs into its mean and unobserved error, as above $C_i(Z_i) = \mu_{C}(Z_i; \vec X_i) + U_{C,i}$, and collect the mean costs and benefits, $\mu \coloneqq \mu_1 - \mu_0 - \mu_C$.
So we can write the first-stage selection equation in full.
\begin{align*}
    D_i(z') &= \indicator{
        \mu(z'; \vec X_i) \geq U_{C,i} - U_i }
        , \;\;\; \text{for } z'=0,1
\end{align*}

Theorem: if selection is Roy style, and sequential ignorability holds, then unobserved benefits play no part in selection.
The only driver in differences in selection are differences in costs (and not benefits).
\[ \Egiven{ D_i(z') }{ U_i = u} = \Egiven{ D_i(z') }{ U_i = u'} \]
For all $u', u$ in the range of the distribution of $U_i$.
Proof: by contradiction, add to the appendix.
This could, for example, hold if $U_{1,i} - U_{0,i}$ is degenerate conditional on $\vec X_i$.

Short paragraph on why this means $\vec X_i$ must be incredibly rich.
Write about if $D_i$ is the choice to attend education, then $\vec X_i$ must soak up all gains to education.
Or assuming that all variation in $D_i$ comes from unobserved differences in take-up costs.
This is unlikely to hold true, absent a separate research design for $D_i$, limiting the selection to an information restricted version of the Roy model.

If not, then selection bias propagates, including writing here for what the selection bias term is equal to. 

\subsection{Applied Settings}

Three parapgraphs on what goes on in empirical settings.
Survey the papers, and speak about it heavily in one paragraph.

table:

name | $Z \to Y$ | design for $Z$ | Primary mediatory | controls | Possible $U$.
